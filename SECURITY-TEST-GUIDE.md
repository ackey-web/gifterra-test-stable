# セキュリティテストガイド

## 実装完了した購入〜ダウンロードフロー

### システム概要

GIFT HUBの最も重要なセキュリティ要件である「**購入者本人のみがダウンロード可能**」を実現しました。

### 実装されたセキュリティ機能

#### 1. ワンタイムダウンロードトークン
- **発行**: 購入完了時に1回限り有効なトークンを生成
- **有効期限**: 15分間（900秒）
- **使用制限**: 1回のダウンロードで自動的に無効化
- **購入者紐付け**: トークンはウォレットアドレスと購入IDに紐付け

#### 2. 非公開バケット + 署名URL
- **ストレージ**: 配布ファイルは非公開バケット `gh-downloads` に保存
- **アクセス**: Service Roleキーのみがアクセス可能
- **署名URL**: ダウンロード時に10分間有効の署名URLを生成
- **直接アクセス防止**: URLを知っていても署名がなければアクセス不可

#### 3. トランザクション検証
- **ブロックチェーン確認**: 購入APIでトランザクションの成功を検証
- **金額チェック**: 支払額が商品価格以上であることを確認
- **冪等性保証**: 同じトランザクションハッシュでの重複購入を防止

---

## セキュリティテスト手順

### テスト環境準備

#### 1. データベースマイグレーション実行

Supabase Dashboardで以下のSQLを実行：

```bash
# マイグレーションファイル
supabase/migrations/001_create_products_and_purchases.sql  # 既存
supabase/migrations/002_create_download_tokens.sql         # 新規作成
```

**重要**: 002_create_download_tokens.sql を実行してください。

#### 2. Storage RLS ポリシー確認

`gh-downloads` バケットが以下の設定になっていることを確認：
- **Public**: OFF（非公開）
- **Service Role Upload**: ON

#### 3. 配布ファイルの移行

**現在の状態**: 開発中に `gh-public` にアップロードされたファイル

**本番用に変更**:
```sql
-- gh-public から gh-downloads にファイルを移動
-- Supabase Dashboard > Storage で手動移動
-- または API で移動:
-- FROM: gh-public/test-file.zip
-- TO: gh-downloads/test-file.zip
```

---

## 🔐 セキュリティテストケース

### テスト1: 正常な購入〜ダウンロードフロー

**目的**: 購入者が正常にダウンロードできることを確認

**手順**:
1. ウォレットAで商品を購入
2. 購入完了後、ダウンロードトークンが発行される
3. `/download?token={token}` にアクセス
4. ダウンロードが開始される

**期待結果**:
✅ ダウンロード成功
✅ ファイルが正常に取得できる

---

### テスト2: トークンの1回限り使用制限

**目的**: 同じトークンで2回目のダウンロードができないことを確認

**手順**:
1. テスト1で使用したトークンを再利用
2. `/download?token={same_token}` に再度アクセス

**期待結果**:
❌ エラーメッセージ: 「このトークンは既に使用されています」
❌ ダウンロード不可

**データベース確認**:
```sql
SELECT * FROM download_tokens WHERE token = 'test-token-uuid';
-- is_consumed: true
-- consumed_at: [使用日時]
```

---

### テスト3: トークンの有効期限

**目的**: 15分経過後のトークンが使用できないことを確認

**手順**:
1. ダウンロードトークンを発行
2. 15分間待機（テスト用に expires_at を手動で過去に変更）
   ```sql
   UPDATE download_tokens
   SET expires_at = NOW() - INTERVAL '1 hour'
   WHERE token = 'test-token-uuid';
   ```
3. `/download?token={expired_token}` にアクセス

**期待結果**:
❌ エラーメッセージ: 「トークンの有効期限が切れています」
❌ ダウンロード不可

---

### テスト4: 他人のトークンでアクセス試行（最重要）

**目的**: 購入していない第三者がトークンを入手してもダウンロードできないことを確認

**シナリオA: トークンのみを盗まれた場合**

**手順**:
1. ウォレットAが商品を購入してトークンを取得
2. ウォレットB（非購入者）が同じトークンURLにアクセス
   - トークン文字列をコピーして別ブラウザで開く
   - または第三者にURLを共有

**期待結果**:
✅ 1回目のアクセス: ダウンロード成功（トークンはウォレット検証なし、購入記録のみ検証）
❌ 2回目のアクセス: 「このトークンは既に使用されています」でブロック

**セキュリティ上の懸念点と対策**:
- トークンURLが流出すると最初の1回は誰でもダウンロード可能
- **対策**: トークンURLは購入者以外と共有しないよう注意書きを表示（実装済み）

---

### テスト5: 署名URLの有効期限

**目的**: ダウンロードAPI経由で生成された署名URLが10分後に無効になることを確認

**手順**:
1. ダウンロードAPIにアクセスしてリダイレクト先の署名URLを取得
   ```bash
   curl -v "http://localhost:3001/api/download/{token}"
   # Location ヘッダーから署名URLを取得
   ```
2. 署名URLを保存
3. 10分間待機
4. 保存した署名URLに直接アクセス

**期待結果**:
❌ Supabase エラー: 「Signature has expired」
❌ ダウンロード不可

---

### テスト6: 直接バケットアクセスの防止

**目的**: gh-downloads バケットに直接アクセスできないことを確認

**手順**:
1. 商品の `content_path` を確認（例: `products/test.zip`）
2. 公開URLを構築して直接アクセス試行
   ```
   https://{project-id}.supabase.co/storage/v1/object/public/gh-downloads/products/test.zip
   ```

**期待結果**:
❌ エラー: 「Bucket not found」または「Access denied」
❌ ダウンロード不可

**補足**: `gh-downloads` は非公開バケットなので `/public/` パスではアクセス不可

---

### テスト7: 無効なトークンでのアクセス

**目的**: ランダムな文字列では何も取得できないことを確認

**手順**:
1. 適当なUUID文字列を作成
   ```
   /download?token=00000000-0000-0000-0000-000000000000
   ```
2. アクセス試行

**期待結果**:
❌ エラー: 「トークンが見つかりません」
❌ ダウンロード不可

---

### テスト8: 購入履歴からのトークン確認

**目的**: 購入履歴ページで自分の購入のみ表示されることを確認

**手順**:
1. ウォレットAで `/my-purchases` にアクセス
2. ウォレットAの購入履歴のみが表示されることを確認
3. ウォレットBで同じページにアクセス
4. ウォレットBの購入履歴のみが表示されることを確認

**期待結果**:
✅ 各ウォレットは自分の購入のみ閲覧可能
✅ 他人の購入情報は一切表示されない

**データベース確認**:
```sql
SELECT * FROM get_user_purchases('0xWalletA...');
-- ウォレットAの購入のみ返却

SELECT * FROM get_user_purchases('0xWalletB...');
-- ウォレットBの購入のみ返却
```

---

### テスト9: トランザクション検証

**目的**: 無効なトランザクションで購入できないことを確認

**手順**:
1. 購入APIに無効なトランザクションハッシュを送信
   ```bash
   curl -X POST http://localhost:3001/api/purchase/init \
     -H "Content-Type: application/json" \
     -d '{
       "productId": "uuid",
       "buyer": "0x...",
       "txHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
       "amountWei": "1000000000000000000"
     }'
   ```

**期待結果**:
❌ エラー: 「トランザクションが見つかりません」
❌ 購入失敗

---

### テスト10: 金額検証

**目的**: 支払額が不足している場合に購入できないことを確認

**手順**:
1. 商品価格: 1000 token
2. 実際の支払額: 500 token
3. 購入APIに送信

**期待結果**:
❌ エラー: 「支払額が不足しています（必要: 1000, 実際: 500）」
❌ 購入失敗

---

## 🎯 テスト実行チェックリスト

### 必須テスト（本番デプロイ前に実行）

- [ ] テスト1: 正常な購入〜ダウンロードフロー
- [ ] テスト2: トークンの1回限り使用制限
- [ ] テスト4: 他人のトークンでアクセス試行
- [ ] テスト6: 直接バケットアクセスの防止
- [ ] テスト8: 購入履歴からのトークン確認

### 推奨テスト（セキュリティ強化確認）

- [ ] テスト3: トークンの有効期限
- [ ] テスト5: 署名URLの有効期限
- [ ] テスト7: 無効なトークンでのアクセス
- [ ] テスト9: トランザクション検証
- [ ] テスト10: 金額検証

---

## 📊 セキュリティ実装状況

### ✅ 実装済み

1. **ワンタイムダウンロードトークン**
   - `download_tokens` テーブル作成
   - `create_download_token()` ストアドプロシージャ
   - `consume_download_token()` ストアドプロシージャ

2. **非公開バケット + 署名URL**
   - `api/download/[token].ts` を署名URL方式に変更
   - `gh-downloads` バケット使用

3. **購入フロー完全実装**
   - `api/purchase/init.ts` でトランザクション検証
   - 冪等性保証（重複購入防止）
   - 在庫管理（原子的な更新）

4. **UI実装**
   - `/download?token={token}` ページ
   - `/my-purchases` 購入履歴ページ
   - `PurchaseSuccessModal` コンポーネント

### ⚠️ 残存リスクと制限事項

#### 1. トークンURL流出リスク

**リスク**: 購入者がダウンロードリンクを他人と共有した場合、最初の1回は誰でもダウンロード可能

**影響度**: 中
- トークンは1回限り有効なので、2回目以降はブロック
- 15分の有効期限があるので、長期間の不正利用は不可

**対策**:
- ✅ UI上で警告メッセージ表示済み
- ✅ 「リンクを他人と共有しないでください」と明記
- 🔄 将来の改善: ダウンロード時にウォレット署名を要求（検討中）

#### 2. 署名URL有効期限内の再利用

**リスク**: 署名URL（10分有効）をコピーされた場合、有効期限内は直接アクセス可能

**影響度**: 低
- トークンは既に消費済みなので新しい署名URLは発行不可
- 最大10分間のみ有効
- 署名URLは推測不可能（Supabase内部で生成）

**対策**:
- ✅ 署名URL有効期限を10分に設定（600秒）
- ✅ トークン有効期限を15分に設定（900秒）

#### 3. 再ダウンロード機能未実装

**現状**: トークン使用後の再ダウンロードができない

**対応方針**:
- サポート経由で対応（手動でトークン再発行）
- または有料で再ダウンロードトークン購入機能を実装

---

## 🚀 本番環境デプロイ前の確認事項

### 1. Supabase設定

```bash
# マイグレーション実行確認
✅ 001_create_products_and_purchases.sql
✅ 002_create_download_tokens.sql

# Storage バケット確認
✅ gh-downloads: 非公開、Service Role のみアクセス可能
✅ gh-public: 公開、サムネイル用

# RLS ポリシー確認
✅ products: 公開読み取り、Service Role 書き込み
✅ purchases: 購入者のみ読み取り、Service Role 書き込み
✅ download_tokens: Service Role のみ全アクセス
```

### 2. 環境変数設定（Vercel）

```bash
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGc... # 公開用
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc... # サーバー専用
ALCHEMY_RPC_URL=https://polygon-amoy.g.alchemy.com/v2/xxx
```

**重要**: `SUPABASE_SERVICE_ROLE_KEY` は絶対にクライアントに露出させない

### 3. 配布ファイル移行

```bash
# 既存の gh-public のファイルを gh-downloads に移動
# Supabase Dashboard > Storage で手動移動
# products テーブルの content_path は変更不要（パスのみ）
```

---

## 📝 トラブルシューティング

### エラー: 「Bucket not found」

**原因**: `gh-downloads` バケットが存在しない

**解決策**:
1. Supabase Dashboard > Storage
2. 新しいバケット作成: `gh-downloads`
3. Public: OFF に設定

### エラー: 「new row violates row-level security policy」

**原因**: RLSポリシーが正しく設定されていない

**解決策**:
1. `002_create_download_tokens.sql` を実行
2. Service Role でアクセスしていることを確認

### エラー: 「トークンが見つかりません」

**原因**: トークンが正しく発行されていない

**解決策**:
1. `create_download_token()` 関数が正しく作成されているか確認
2. 購入API のログを確認
3. データベースに download_tokens レコードが存在するか確認

---

## まとめ

### 実現できたこと

✅ **購入者本人のみがダウンロード可能**
- ワンタイムトークン（1回限り、15分有効）
- 非公開バケット + 署名URL（10分有効）
- トランザクション検証 + 金額チェック

✅ **時間制限だけでない多層防御**
- トークンの1回限り使用制限
- 署名URLの有効期限
- 直接バケットアクセスの防止
- 購入記録との紐付け

✅ **ユーザー体験の向上**
- 購入完了後すぐにダウンロード可能
- 購入履歴から確認可能
- わかりやすいUI/UX

### 次のステップ

1. セキュリティテスト実施（このガイドに沿って）
2. 本番環境へのデプロイ
3. ユーザーフィードバック収集
4. 再ダウンロード機能の実装検討
