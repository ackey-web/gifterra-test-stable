// components/PatentSafeNFTWidget.tsx
import React, { useState } from "react";
import { useGifterraSystem } from "../hooks/useGifterraSystem";

/**
 * @title PatentSafeNFTWidget  
 * @notice æ—¢å­˜Reward UIã«çµ±åˆã™ã‚‹ç‰¹è¨±å›é¿NFTã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
 * 
 * ã€çµ±åˆè¨­è¨ˆã€‘
 * - æ—¢å­˜ã®Daily Reward UIã‚’å¦¨ã’ãªã„
 * - ç‰¹è¨±å¯¾è±¡æ©Ÿèƒ½ã¨æ˜ç¢ºã«åˆ†é›¢è¡¨ç¤º
 * - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å®‰å…¨æ€§ã‚’æ˜ç¤º
 */

interface PatentSafeNFTWidgetProps {
  systemId?: number;
  className?: string;
}

export const PatentSafeNFTWidget: React.FC<PatentSafeNFTWidgetProps> = ({
  systemId = 1,
  className = ""
}) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [mintAddress, setMintAddress] = useState("");
  const [mintPrice] = useState("0.01");

  const {
    systemInfo,
    stats,
    publicMintStandardNFT,
    isLoading,
    error,
    isSystemReady
  } = useGifterraSystem(systemId);

  const handlePublicMint = async () => {
    if (!mintAddress) {
      alert("ãƒŸãƒ³ãƒˆå…ˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    try {
      await publicMintStandardNFT("", mintPrice);
      alert("âœ… é€šå¸¸NFTã®ãƒŸãƒ³ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼");
      setMintAddress("");
    } catch (error: any) {
      alert(`âŒ ãƒŸãƒ³ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    }
  };

  if (!isSystemReady) {
    return (
      <div className={`patent-safe-widget loading ${className}`}>
        <div className="widget-header">
          <span>ğŸ›¡ï¸ ç‰¹è¨±å›é¿NFT</span>
          <small>èª­ã¿è¾¼ã¿ä¸­...</small>
        </div>
      </div>
    );
  }

  return (
    <div className={`patent-safe-widget ${className}`}>
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div 
        className="widget-header"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="header-content">
          <span className="title">ğŸ›¡ï¸ ç‰¹è¨±å›é¿NFT</span>
          <div className="subtitle">
            <small>é€šå¸¸NFTï¼ˆè­²æ¸¡å¯èƒ½ï¼‰</small>
            <span className="expand-icon">{isExpanded ? "â–¼" : "â–¶"}</span>
          </div>
        </div>
      </div>

      {/* å±•é–‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      {isExpanded && (
        <div className="widget-content">
          {/* å®‰å…¨æ€§è¡¨ç¤º */}
          <div className="safety-notice">
            <div className="safe-badge">âœ… ç‰¹è¨±å¯¾è±¡å¤–</div>
            <p>ã“ã®NFTã¯ç‰¹è¨±å›é¿è¨­è¨ˆã«ã‚ˆã‚Šå®‰å…¨ã§ã™</p>
          </div>

          {/* çµ±è¨ˆæƒ…å ± */}
          {stats?.nft && (
            <div className="nft-stats">
              <div className="stat-item">
                <span>ç™ºè¡Œæ¸ˆã¿:</span>
                <span>{stats.nft.totalSupply}</span>
              </div>
              <div className="stat-item">
                <span>ãƒŸãƒ³ãƒˆä¾¡æ ¼:</span>
                <span>{stats.nft.currentMintPrice} MATIC</span>
              </div>
              <div className="stat-item">
                <span>çŠ¶æ…‹:</span>
                <span className={stats.nft.isPublicMintEnabled ? "enabled" : "disabled"}>
                  {stats.nft.isPublicMintEnabled ? "ğŸŸ¢ åˆ©ç”¨å¯èƒ½" : "ğŸ”´ åœæ­¢ä¸­"}
                </span>
              </div>
            </div>
          )}

          {/* ãƒŸãƒ³ãƒˆæ©Ÿèƒ½ */}
          {stats?.nft.isPublicMintEnabled && (
            <div className="mint-section">
              <h4>ğŸ¯ ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒŸãƒ³ãƒˆ</h4>
              <div className="mint-form">
                <input
                  type="text"
                  placeholder="ãƒŸãƒ³ãƒˆå…ˆã‚¢ãƒ‰ãƒ¬ã‚¹"
                  value={mintAddress}
                  onChange={(e) => setMintAddress(e.target.value)}
                />
                <button
                  onClick={handlePublicMint}
                  disabled={isLoading || !mintAddress}
                  className="mint-button"
                >
                  {isLoading ? "å‡¦ç†ä¸­..." : `${stats.nft.currentMintPrice} MATIC ã§ãƒŸãƒ³ãƒˆ`}
                </button>
              </div>
              <p className="mint-note">
                ğŸ“ æ‰‹å‹•æ“ä½œã«ã‚ˆã‚‹å®‰å…¨ãªãƒŸãƒ³ãƒˆï¼ˆè‡ªå‹•å‡¦ç†ãªã—ï¼‰
              </p>
            </div>
          )}

          {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
          {error && (
            <div className="error-message">
              âš ï¸ {error}
            </div>
          )}

          {/* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæƒ…å ± */}
          <div className="contract-info">
            <small>
              <strong>Contract:</strong> {systemInfo?.standardNFT.slice(0, 10)}...
            </small>
          </div>
        </div>
      )}

      {/* ã‚¹ã‚¿ã‚¤ãƒ« */}
      <style>{`
        .patent-safe-widget {
          background: rgba(255, 255, 255, 0.08);
          border: 1px solid rgba(76, 175, 80, 0.3);
          border-radius: 12px;
          margin: 16px 0;
          overflow: hidden;
          transition: all 0.3s ease;
        }

        .patent-safe-widget.loading {
          opacity: 0.6;
        }

        .widget-header {
          padding: 12px 16px;
          cursor: pointer;
          background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(129, 199, 132, 0.1) 100%);
          transition: background 0.3s ease;
        }

        .widget-header:hover {
          background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(129, 199, 132, 0.15) 100%);
        }

        .header-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .title {
          font-size: 14px;
          font-weight: 600;
          color: #4caf50;
        }

        .subtitle {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 11px;
          opacity: 0.8;
        }

        .expand-icon {
          transition: transform 0.3s ease;
        }

        .widget-content {
          padding: 16px;
        }

        .safety-notice {
          background: linear-gradient(135deg, #c8e6c9 0%, #e8f5e8 100%);
          border: 1px solid #4caf50;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 16px;
          color: #2e7d32;
        }

        .safe-badge {
          display: inline-block;
          background: #4caf50;
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 10px;
          font-weight: 600;
          margin-bottom: 4px;
        }

        .safety-notice p {
          margin: 0;
          font-size: 12px;
        }

        .nft-stats {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 8px;
          margin-bottom: 16px;
        }

        .stat-item {
          display: flex;
          justify-content: space-between;
          font-size: 12px;
          padding: 4px 0;
        }

        .stat-item span:first-child {
          opacity: 0.8;
        }

        .stat-item span:last-child {
          font-weight: 600;
        }

        .enabled {
          color: #4caf50;
        }

        .disabled {
          color: #f44336;
        }

        .mint-section {
          border-top: 1px solid rgba(255, 255, 255, 0.1);
          padding-top: 16px;
        }

        .mint-section h4 {
          margin: 0 0 12px 0;
          font-size: 13px;
          color: #4caf50;
        }

        .mint-form {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .mint-form input {
          padding: 8px 12px;
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 6px;
          background: rgba(255, 255, 255, 0.05);
          color: white;
          font-size: 12px;
        }

        .mint-form input::placeholder {
          color: rgba(255, 255, 255, 0.5);
        }

        .mint-button {
          padding: 10px 16px;
          background: #4caf50;
          color: white;
          border: none;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 600;
          cursor: pointer;
          transition: background 0.3s ease;
        }

        .mint-button:hover:not(:disabled) {
          background: #45a049;
        }

        .mint-button:disabled {
          background: #666;
          cursor: not-allowed;
        }

        .mint-note {
          margin: 8px 0 0 0;
          font-size: 10px;
          opacity: 0.7;
          font-style: italic;
        }

        .error-message {
          background: rgba(244, 67, 54, 0.1);
          border: 1px solid rgba(244, 67, 54, 0.3);
          color: #f44336;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 12px;
          margin: 12px 0;
        }

        .contract-info {
          margin-top: 12px;
          padding-top: 8px;
          border-top: 1px solid rgba(255, 255, 255, 0.05);
          opacity: 0.6;
        }

        .contract-info small {
          font-family: 'Monaco', monospace;
          font-size: 10px;
        }

        @media (max-width: 480px) {
          .nft-stats {
            grid-template-columns: 1fr;
          }
          
          .widget-header {
            padding: 10px 12px;
          }
          
          .widget-content {
            padding: 12px;
          }
        }
      `}</style>
    </div>
  );
};